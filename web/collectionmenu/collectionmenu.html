<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Collection Menu</title>
  <style>
    html,
  body {
    margin: 0;
    padding: 0;
    height: 100%;
    background-color: #111;
    color: #fff;
    font-family: sans-serif;
    font-size: 2.5vh;

    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding-top: 2vh;
  }

  #menu-container {
    display: inline-block;
    transition: transform 0.3s ease;
    transform-origin: center center;
  }

    .menu-title {
      font-size: 3.75vh;
      font-weight: bold;
      text-align: center;
      margin-bottom: 1vh;
      padding: 1vh;
      color: #fff;
    }

    ul.menu {
      list-style: none;
      padding: 1vh;
      margin: 0;
    }

    li.menu-item {
      padding: 0.75vh 1vw;
      margin-bottom: 0.5vh;
      background-color: #222;
      border-radius: 0.5vh;
      cursor: pointer;
      position: relative;
      font-size: 2.34vh;
    }

    li.menu-item.selected {
      background-color: #444;
    }

    li.menu-item.filter-separator {
      margin-top: 2vh;
    }

    li.menu-item.action-separator {
      margin-top: 2vh;
    }

    .dropdown-label {
      display: inline-block;
      min-width: 30vw;
    }

    .dropdown-value {
      display: inline-block;
      font-weight: bold;
      margin-left: 2vw;
    }

    .popup {
      position: absolute;
      top: 100%;
      left: 0;
      background: #333;
      border: 1px solid #555;
      z-index: 1000;
      width: 100%;
      max-height: 60vh;
      overflow-y: auto;
      overflow-x: hidden;
      font-size: 2.34vh;
    }

    .popup-option {
      padding: 0.5vh 1vw;
    }

    .popup-option.selected {
      background: #666;
    }

    #overlay-root {
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }

    #overlay-root.active {
      opacity: 1;
      pointer-events: auto;
    }

    .table-count {
      text-align: center;
      font-size: 2.34vh;
      padding: 1vh;
      margin-top: 1vh;
      color: #aaa;
    }
  </style>
</head>

<body>
  <div id="menu-container">
    <div class="menu-title">Collection / Filter</div>
    <ul class="menu" id="menu">
      <li class="menu-item" id="collection-item">
        <span class="dropdown-label">Collections:</span>
        <span class="dropdown-value" id="collection-value">None</span>
      </li>
      <li class="menu-item filter-separator" id="letter-item">
        <span class="dropdown-label">Starting Letter:</span>
        <span class="dropdown-value" id="letter-value">All</span>
      </li>
      <li class="menu-item" id="theme-item">
        <span class="dropdown-label">Theme:</span>
        <span class="dropdown-value" id="theme-value">All</span>
      </li>
      <li class="menu-item" id="type-item">
        <span class="dropdown-label">Type:</span>
        <span class="dropdown-value" id="type-value">All</span>
      </li>
      <li class="menu-item" id="manufacturer-item">
        <span class="dropdown-label">Manufacturer:</span>
        <span class="dropdown-value" id="manufacturer-value">All</span>
      </li>
      <li class="menu-item" id="year-item">
        <span class="dropdown-label">Year:</span>
        <span class="dropdown-value" id="year-value">All</span>
      </li>
      <li class="menu-item" id="sortby-item">
        <span class="dropdown-label">Sort By:</span>
        <span class="dropdown-value" id="sortby-value">Alpha</span>
      </li>
      <li class="menu-item action-separator" id="save-filter-item">Save Filter...</li>
      <li class="menu-item" id="close-item">Close</li>
    </ul>

    <div class="table-count" id="table-count">Table Count: 0</div>

    <!-- Popup for dropdown -->
    <div id="dropdown-popup" class="popup" style="display: none;"></div>

    <!-- Dialog for saving filters -->
    <div id="save-filter-dialog" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #222; border: 2px solid #555; padding: 1.5vh 2vw; z-index: 2000; border-radius: 0.5vh;">
      <div style="font-size: 2.82vh; margin-bottom: 1vh;">Save Current Filter</div>
      <input type="text" id="filter-name-input" placeholder="Enter filter name..." style="width: 100%; padding: 0.5vh; font-size: 2.34vh; background: #333; color: #fff; border: 1px solid #555; border-radius: 0.25vh; margin-bottom: 1vh;">
      <div style="display: flex; gap: 1vw;">
        <button id="save-filter-btn" style="flex: 1; padding: 0.5vh; font-size: 2.34vh; background: #444; color: #fff; border: 1px solid #666; border-radius: 0.25vh; cursor: pointer;">Save</button>
        <button id="cancel-save-btn" style="flex: 1; padding: 0.5vh; font-size: 2.34vh; background: #333; color: #fff; border: 1px solid #555; border-radius: 0.25vh; cursor: pointer;">Cancel</button>
      </div>
      <div id="save-message" style="margin-top: 0.75vh; font-size: 1.88vh; text-align: center;"></div>
    </div>
  </div>

  <script>
    let rotationAngle = 0; // starting angle
    let selectedIndex = 0;
    let items = [];
    let dropdownOpen = false;
    let dropdownSelected = 0;
    let currentDropdownType = null;

    // Filter data
    let collections = ['None'];
    let letters = ['All'];
    let themes = ['All'];
    let types = ['All'];
    let manufacturers = ['All'];
    let years = ['All'];
    let sortOptions = ['Alpha', 'Newest'];

    // Current selections
    let collectionIndex = 0;
    let letterIndex = 0;
    let themeIndex = 0;
    let typeIndex = 0;
    let manufacturerIndex = 0;
    let yearIndex = 0;
    let sortByIndex = 0;

    async function init() {
      collections = collections.concat(await window.parent.vpin.call('get_collections'));
      letters = letters.concat(await window.parent.vpin.call('get_filter_letters'));
      themes = themes.concat(await window.parent.vpin.call('get_filter_themes'));
      types = types.concat(await window.parent.vpin.call('get_filter_types'));
      manufacturers = manufacturers.concat(await window.parent.vpin.call('get_filter_manufacturers'));
      years = years.concat(await window.parent.vpin.call('get_filter_years'));

      // Get current collection and set index
      const currentCollection = await window.parent.vpin.call('get_current_collection');
      collectionIndex = collections.indexOf(currentCollection);
      if (collectionIndex === -1) collectionIndex = 0; // fallback to None

      // Get current filter state and set indices
      const currentFilters = await window.parent.vpin.call('get_current_filter_state');
      letterIndex = letters.indexOf(currentFilters.letter || 'All');
      if (letterIndex === -1) letterIndex = 0;
      themeIndex = themes.indexOf(currentFilters.theme || 'All');
      if (themeIndex === -1) themeIndex = 0;
      typeIndex = types.indexOf(currentFilters.type || 'All');
      if (typeIndex === -1) typeIndex = 0;
      manufacturerIndex = manufacturers.indexOf(currentFilters.manufacturer || 'All');
      if (manufacturerIndex === -1) manufacturerIndex = 0;
      yearIndex = years.indexOf(currentFilters.year || 'All');
      if (yearIndex === -1) yearIndex = 0;

      // Get current sort state
      const currentSort = await window.parent.vpin.call('get_current_sort_state');
      sortByIndex = sortOptions.indexOf(currentSort);
      if (sortByIndex === -1) sortByIndex = 0;

      window.parent.vpin.call("console_out", "Collection menu filters loaded");
    }

    window.parent.vpin.registerInputHandlerCollectionMenu(handleInput);

    // Keyboard input handler for collection menu (mirrors vpinfe-core.js mappings)
    // ShiftLeft = up/left, ShiftRight = down/right, Enter = select
    window.addEventListener('keydown', (e) => {
      if (e.code === 'ShiftLeft' || e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
        handleInput("joyleft");
        e.preventDefault();
      } else if (e.code === 'ShiftRight' || e.key === 'ArrowRight' || e.key === 'ArrowDown') {
        handleInput("joyright");
        e.preventDefault();
      } else if (e.key === 'Enter') {
        handleInput("joyselect");
        e.preventDefault();
      } else if (e.key === 'Escape') {
        handleInput("joyback");
        e.preventDefault();
      }
    });

    window.addEventListener("message", (event) => {
      const message = event.data;
      if (message.event === "reset state") {
        selectedIndex = 0;
        dropdownOpen = false;
        updateMenu();
      }
    });

    window.addEventListener("DOMContentLoaded", () => {
      rotateMenu(rotationAngle); // apply initial rotation
    });

    function rotateMenu(degrees) {
      rotationAngle = degrees;
      document.getElementById('menu-container').style.transform =
        `rotate(${rotationAngle}deg)`;
    }

    function handleInput(input) {
      if (dropdownOpen) {
        const currentOptions = getCurrentDropdownOptions();
        switch (input) {
          case "joyup":
          case "joyleft":
            dropdownSelected = (dropdownSelected - 1 + currentOptions.length) % currentOptions.length;
            updateDropdownPopup();
            break;
          case "joydown":
          case "joyright":
            dropdownSelected = (dropdownSelected + 1) % currentOptions.length;
            updateDropdownPopup();
            break;
          case "joyselect":
            applyDropdownSelection();
            closeDropdown();
            break;
          case "joyback":
            closeDropdown();
            break;
        }
        return;
      }

      switch (input) {
        case "joyup":
        case "joyleft":
          selectedIndex = (selectedIndex - 1 + items.length) % items.length;
          break;
        case "joydown":
        case "joyright":
          selectedIndex = (selectedIndex + 1) % items.length;
          break;
        case "joyselect":
          const selectedItem = items[selectedIndex];
          if (selectedItem.id === 'collection-item') {
            openDropdown(selectedItem, 'collection');
          } else if (selectedItem.id === 'letter-item') {
            openDropdown(selectedItem, 'letter');
          } else if (selectedItem.id === 'theme-item') {
            openDropdown(selectedItem, 'theme');
          } else if (selectedItem.id === 'type-item') {
            openDropdown(selectedItem, 'type');
          } else if (selectedItem.id === 'manufacturer-item') {
            openDropdown(selectedItem, 'manufacturer');
          } else if (selectedItem.id === 'year-item') {
            openDropdown(selectedItem, 'year');
          } else if (selectedItem.id === 'sortby-item') {
            openDropdown(selectedItem, 'sortby');
          } else if (selectedItem.id === 'save-filter-item') {
            openSaveFilterDialog();
          } else if (selectedItem.id === 'close-item') {
            window.parent.vpin.toggleCollectionMenu();
          }
          break;
        case "joyback":
        case "joymenu":
        case "joycollectionmenu":
          window.parent.vpin.toggleCollectionMenu();
          break;
      }
      updateMenu();
    }

    function updateTableCount() {
      const tableCount = window.parent.vpin.tableData ? window.parent.vpin.tableData.length : 0;
      document.getElementById('table-count').textContent = `Table Count: ${tableCount}`;
    }

    function updateMenu() {
      items.forEach((item, i) => {
        item.classList.toggle('selected', i === selectedIndex);
      });

      document.getElementById('collection-value').textContent = collections[collectionIndex];
      document.getElementById('letter-value').textContent = letters[letterIndex];
      document.getElementById('theme-value').textContent = themes[themeIndex];
      document.getElementById('type-value').textContent = types[typeIndex];
      document.getElementById('manufacturer-value').textContent = manufacturers[manufacturerIndex];
      document.getElementById('year-value').textContent = years[yearIndex];
      document.getElementById('sortby-value').textContent = sortOptions[sortByIndex];

      updateTableCount();
    }

    function getCurrentDropdownOptions() {
      switch (currentDropdownType) {
        case 'collection': return collections;
        case 'letter': return letters;
        case 'theme': return themes;
        case 'type': return types;
        case 'manufacturer': return manufacturers;
        case 'year': return years;
        case 'sortby': return sortOptions;
        default: return [];
      }
    }

    function getCurrentIndex() {
      switch (currentDropdownType) {
        case 'collection': return collectionIndex;
        case 'letter': return letterIndex;
        case 'theme': return themeIndex;
        case 'type': return typeIndex;
        case 'manufacturer': return manufacturerIndex;
        case 'year': return yearIndex;
        case 'sortby': return sortByIndex;
        default: return 0;
      }
    }

    function openDropdown(targetItem, dropdownType) {
      dropdownOpen = true;
      currentDropdownType = dropdownType;
      dropdownSelected = getCurrentIndex();

      const popup = document.getElementById('dropdown-popup');
      popup.style.display = 'block';
      popup.style.top = (targetItem.offsetTop + targetItem.offsetHeight) + 'px';
      popup.style.left = targetItem.offsetLeft + 'px';
      popup.style.width = targetItem.offsetWidth + 'px';

      updateDropdownPopup();
    }

    function updateDropdownPopup() {
      const popup = document.getElementById('dropdown-popup');
      popup.innerHTML = '';
      const options = getCurrentDropdownOptions();
      options.forEach((option, i) => {
        const div = document.createElement('div');
        div.className = 'popup-option' + (i === dropdownSelected ? ' selected' : '');
        div.textContent = option;
        popup.appendChild(div);
      });

      // Scroll selected item into view
      const selectedElement = popup.querySelector('.popup-option.selected');
      if (selectedElement) {
        selectedElement.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
      }
    }

    async function applyDropdownSelection() {
      const options = getCurrentDropdownOptions();
      const selectedValue = options[dropdownSelected];

      switch (currentDropdownType) {
        case 'collection':
          collectionIndex = dropdownSelected;

          if (selectedValue == "None") {
            // Reset all filters when "None" is selected
            letterIndex = 0;
            themeIndex = 0;
            typeIndex = 0;
            manufacturerIndex = 0;
            yearIndex = 0;

            await window.parent.vpin.call("get_tables", true);
            window.parent.vpin.sendMessageToAllWindowsIncSelf({
              type: "TableDataChange",
              index: 0,
              collection: "None"
            });
          } else {
            // Load the collection (could be VPS ID-based or filter-based)
            await window.parent.vpin.call("set_tables_by_collection", selectedValue);

            // Get the updated table data after collection is loaded
            await window.parent.vpin.call("get_tables");

            // Get current filter state from API to update UI
            const filterState = await window.parent.vpin.call("get_current_filter_state");

            if (filterState && filterState.letter !== null) {
              // Filter-based collection - update UI to show active filters
              letterIndex = letters.indexOf(filterState.letter);
              themeIndex = themes.indexOf(filterState.theme);
              typeIndex = types.indexOf(filterState.type);
              manufacturerIndex = manufacturers.indexOf(filterState.manufacturer);
              yearIndex = years.indexOf(filterState.year);

              // Get and set the sort order if available
              const sortState = await window.parent.vpin.call("get_current_sort_state");
              if (sortState) {
                const sortIdx = sortOptions.indexOf(sortState);
                if (sortIdx !== -1) {
                  sortByIndex = sortIdx;
                }
              }

              // Send as filter message with sort information
              window.parent.vpin.sendMessageToAllWindowsIncSelf({
                type: "TableDataChange",
                index: 0,
                filters: {
                  letter: filterState.letter,
                  theme: filterState.theme,
                  type: filterState.type,
                  manufacturer: filterState.manufacturer,
                  year: filterState.year
                },
                sort: sortState || 'Alpha'
              });
            } else {
              // VPS ID-based collection - reset filter UI
              letterIndex = 0;
              themeIndex = 0;
              typeIndex = 0;
              manufacturerIndex = 0;
              yearIndex = 0;

              window.parent.vpin.sendMessageToAllWindowsIncSelf({
                type: "TableDataChange",
                index: 0,
                collection: selectedValue
              });
            }
          }
          updateMenu();

          // Close the collection menu after selecting a collection
          window.parent.vpin.toggleCollectionMenu();
          break;

        case 'letter':
          letterIndex = dropdownSelected;
          collectionIndex = 0;

          const letterCount = await window.parent.vpin.call("apply_filters",
            letters[letterIndex] === "All" ? "All" : letters[letterIndex],
            themes[themeIndex] === "All" ? "All" : themes[themeIndex],
            types[typeIndex] === "All" ? "All" : types[typeIndex],
            manufacturers[manufacturerIndex] === "All" ? "All" : manufacturers[manufacturerIndex],
            years[yearIndex] === "All" ? "All" : years[yearIndex]
          );
          window.parent.vpin.sendMessageToAllWindowsIncSelf({
            type: "TableDataChange",
            index: 0,
            filters: {
              letter: letters[letterIndex] === "All" ? "All" : letters[letterIndex],
              theme: themes[themeIndex] === "All" ? "All" : themes[themeIndex],
              type: types[typeIndex] === "All" ? "All" : types[typeIndex],
              manufacturer: manufacturers[manufacturerIndex] === "All" ? "All" : manufacturers[manufacturerIndex],
              year: years[yearIndex] === "All" ? "All" : years[yearIndex]
            }
          });
          document.getElementById('table-count').textContent = `Table Count: ${letterCount}`;
          break;

        case 'theme':
          themeIndex = dropdownSelected;
          collectionIndex = 0;

          const themeCount = await window.parent.vpin.call("apply_filters",
            letters[letterIndex] === "All" ? "All" : letters[letterIndex],
            themes[themeIndex] === "All" ? "All" : themes[themeIndex],
            types[typeIndex] === "All" ? "All" : types[typeIndex],
            manufacturers[manufacturerIndex] === "All" ? "All" : manufacturers[manufacturerIndex],
            years[yearIndex] === "All" ? "All" : years[yearIndex]
          );
          window.parent.vpin.sendMessageToAllWindowsIncSelf({
            type: "TableDataChange",
            index: 0,
            filters: {
              letter: letters[letterIndex] === "All" ? "All" : letters[letterIndex],
              theme: themes[themeIndex] === "All" ? "All" : themes[themeIndex],
              type: types[typeIndex] === "All" ? "All" : types[typeIndex],
              manufacturer: manufacturers[manufacturerIndex] === "All" ? "All" : manufacturers[manufacturerIndex],
              year: years[yearIndex] === "All" ? "All" : years[yearIndex]
            }
          });
          document.getElementById('table-count').textContent = `Table Count: ${themeCount}`;
          break;

        case 'type':
          typeIndex = dropdownSelected;
          collectionIndex = 0;

          const typeCount = await window.parent.vpin.call("apply_filters",
            letters[letterIndex] === "All" ? "All" : letters[letterIndex],
            themes[themeIndex] === "All" ? "All" : themes[themeIndex],
            types[typeIndex] === "All" ? "All" : types[typeIndex],
            manufacturers[manufacturerIndex] === "All" ? "All" : manufacturers[manufacturerIndex],
            years[yearIndex] === "All" ? "All" : years[yearIndex]
          );
          window.parent.vpin.sendMessageToAllWindowsIncSelf({
            type: "TableDataChange",
            index: 0,
            filters: {
              letter: letters[letterIndex] === "All" ? "All" : letters[letterIndex],
              theme: themes[themeIndex] === "All" ? "All" : themes[themeIndex],
              type: types[typeIndex] === "All" ? "All" : types[typeIndex],
              manufacturer: manufacturers[manufacturerIndex] === "All" ? "All" : manufacturers[manufacturerIndex],
              year: years[yearIndex] === "All" ? "All" : years[yearIndex]
            }
          });
          document.getElementById('table-count').textContent = `Table Count: ${typeCount}`;
          break;

        case 'manufacturer':
          manufacturerIndex = dropdownSelected;
          collectionIndex = 0;

          const manufacturerCount = await window.parent.vpin.call("apply_filters",
            letters[letterIndex] === "All" ? "All" : letters[letterIndex],
            themes[themeIndex] === "All" ? "All" : themes[themeIndex],
            types[typeIndex] === "All" ? "All" : types[typeIndex],
            manufacturers[manufacturerIndex] === "All" ? "All" : manufacturers[manufacturerIndex],
            years[yearIndex] === "All" ? "All" : years[yearIndex]
          );
          window.parent.vpin.sendMessageToAllWindowsIncSelf({
            type: "TableDataChange",
            index: 0,
            filters: {
              letter: letters[letterIndex] === "All" ? "All" : letters[letterIndex],
              theme: themes[themeIndex] === "All" ? "All" : themes[themeIndex],
              type: types[typeIndex] === "All" ? "All" : types[typeIndex],
              manufacturer: manufacturers[manufacturerIndex] === "All" ? "All" : manufacturers[manufacturerIndex],
              year: years[yearIndex] === "All" ? "All" : years[yearIndex]
            }
          });
          document.getElementById('table-count').textContent = `Table Count: ${manufacturerCount}`;
          break;

        case 'year':
          yearIndex = dropdownSelected;
          collectionIndex = 0;

          const yearCount = await window.parent.vpin.call("apply_filters",
            letters[letterIndex] === "All" ? "All" : letters[letterIndex],
            themes[themeIndex] === "All" ? "All" : themes[themeIndex],
            types[typeIndex] === "All" ? "All" : types[typeIndex],
            manufacturers[manufacturerIndex] === "All" ? "All" : manufacturers[manufacturerIndex],
            years[yearIndex] === "All" ? "All" : years[yearIndex]
          );
          window.parent.vpin.sendMessageToAllWindowsIncSelf({
            type: "TableDataChange",
            index: 0,
            filters: {
              letter: letters[letterIndex] === "All" ? "All" : letters[letterIndex],
              theme: themes[themeIndex] === "All" ? "All" : themes[themeIndex],
              type: types[typeIndex] === "All" ? "All" : types[typeIndex],
              manufacturer: manufacturers[manufacturerIndex] === "All" ? "All" : manufacturers[manufacturerIndex],
              year: years[yearIndex] === "All" ? "All" : years[yearIndex]
            }
          });
          document.getElementById('table-count').textContent = `Table Count: ${yearCount}`;
          break;

        case 'sortby':
          sortByIndex = dropdownSelected;

          const sortCount = await window.parent.vpin.call("apply_sort", sortOptions[sortByIndex]);
          window.parent.vpin.sendMessageToAllWindowsIncSelf({
            type: "TableDataChange",
            index: 0,
            sort: sortOptions[sortByIndex]
          });
          document.getElementById('table-count').textContent = `Table Count: ${sortCount}`;
          break;
      }

      window.parent.vpin.call("console_out", `Filter applied: ${currentDropdownType} = ${selectedValue}`);
    }

    function closeDropdown() {
      dropdownOpen = false;
      document.getElementById('dropdown-popup').style.display = 'none';
      updateMenu();
    }

    function openSaveFilterDialog() {
      const dialog = document.getElementById('save-filter-dialog');
      const input = document.getElementById('filter-name-input');
      const message = document.getElementById('save-message');

      input.value = '';
      message.textContent = '';
      dialog.style.display = 'block';
      input.focus();
    }

    function closeSaveFilterDialog() {
      const dialog = document.getElementById('save-filter-dialog');
      dialog.style.display = 'none';
    }

    async function saveCurrentFilter() {
      const input = document.getElementById('filter-name-input');
      const message = document.getElementById('save-message');
      const filterName = input.value.trim();

      if (!filterName) {
        message.textContent = 'Please enter a filter name';
        message.style.color = '#f88';
        return;
      }

      // Check if any filters or sort are set (not all defaults)
      const hasActiveFilters =
        (letters[letterIndex] !== "All") ||
        (themes[themeIndex] !== "All") ||
        (types[typeIndex] !== "All") ||
        (manufacturers[manufacturerIndex] !== "All") ||
        (years[yearIndex] !== "All") ||
        (sortOptions[sortByIndex] !== "Alpha");

      if (!hasActiveFilters) {
        message.textContent = 'No filters or sort order active. Set at least one before saving.';
        message.style.color = '#f88';
        return;
      }

      // Save the filter
      const result = await window.parent.vpin.call("save_filter_collection",
        filterName,
        letters[letterIndex] === "All" ? "All" : letters[letterIndex],
        themes[themeIndex] === "All" ? "All" : themes[themeIndex],
        types[typeIndex] === "All" ? "All" : types[typeIndex],
        manufacturers[manufacturerIndex] === "All" ? "All" : manufacturers[manufacturerIndex],
        years[yearIndex] === "All" ? "All" : years[yearIndex],
        sortOptions[sortByIndex]
      );

      if (result.success) {
        message.textContent = result.message;
        message.style.color = '#8f8';

        // Reload collections list
        collections = ['None'].concat(await window.parent.vpin.call('get_collections'));

        // Close dialog after 2 seconds
        setTimeout(() => {
          closeSaveFilterDialog();
        }, 2000);
      } else {
        message.textContent = result.message;
        message.style.color = '#f88';
      }
    }

    window.onload = async () => {
      await init();
      items = Array.from(document.querySelectorAll('.menu-item'));
      updateMenu();

      // Set up save filter dialog buttons
      document.getElementById('save-filter-btn').addEventListener('click', saveCurrentFilter);
      document.getElementById('cancel-save-btn').addEventListener('click', closeSaveFilterDialog);

      // Allow Enter key to save
      document.getElementById('filter-name-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          saveCurrentFilter();
        }
      });
    };
  </script>
</body>

</html>
