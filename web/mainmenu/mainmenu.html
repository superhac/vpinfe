<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Gamepad Controlled Menu</title>
  <style>
    html,
  body {
    margin: 0;
    padding: 0;
    height: 100%;
    background-color: #111;
    color: #fff;
    font-family: sans-serif;
    font-size: 2.5vh;

    display: flex;               /* enable flex layout */
    justify-content: center;     /* center horizontally */
    align-items: center;         /* center vertically */
  }

  #menu-container {
    display: inline-block;       /* shrink to contents */
    transition: transform 0.3s ease;
    transform-origin: center center;
  }

    ul.menu {
      list-style: none;
      padding: 2vh;
      margin: 0;
    }

    li.menu-item {
      padding: 1.5vh 2vw;
      margin-bottom: 1vh;
      background-color: #222;
      border-radius: 1vh;
      cursor: pointer;
      position: relative;
    }

    li.menu-item.selected {
      background-color: #444;
    }

    #overlay-root {
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }

    #overlay-root.active {
      opacity: 1;
      pointer-events: auto;
    }
  </style>
</head>

<body>
  <div id="menu-container">
    <ul class="menu" id="menu">
      <li class="menu-item">Settings</li>
      <li class="menu-item">High Scores</li>
      <li class="menu-item" id="quit-item">Quit</li>
    </ul>
  </div>

  <script>
    let rotationAngle = 0; // starting angle
    let selectedIndex = 0;
    let items = [];

    window.parent.vpin.registerInputHandlerMenu(handleInput);

    window.addEventListener("message", (event) => {
      const message = event.data;
      if (message.event === "reset state") {
        selectedIndex = 0;
        updateMenu();
      }
    });

    window.addEventListener("DOMContentLoaded", () => {
      rotateMenu(rotationAngle); // apply initial rotation
    });

    function rotateMenu(degrees) {
      rotationAngle = (rotationAngle) % 360;
      document.getElementById('menu-container').style.transform =
        `rotate(${rotationAngle}deg)`;
    }

    function handleInput(input) {
      console.log("got input: " + input);

      switch (input) {
        case "joyup":
          selectedIndex = (selectedIndex - 1 + items.length) % items.length;
          break;
        case "joydown":
          selectedIndex = (selectedIndex + 1) % items.length;
          break;
        case "joyselect":
          const selectedItem = items[selectedIndex];
          if (selectedItem.id === 'quit-item') {
            window.parent.vpin.call("close_app");
          }
          break;
        case "joyleft":
          rotateMenu(-10); // rotate left
          break;
        case "joyright":
          rotateMenu(10);  // rotate right
          break;
      }
      updateMenu();
    }

    function updateMenu() {
      items.forEach((item, i) => {
        item.classList.toggle('selected', i === selectedIndex);
      });
    }

    window.onload = async () => {
      items = Array.from(document.querySelectorAll('.menu-item'));
      updateMenu();
    };
  </script>
</body>

</html>
