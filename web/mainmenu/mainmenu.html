<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Gamepad Controlled Menu</title>
  <style>
    html,
  body {
    margin: 0;
    padding: 0;
    height: 100%;
    background: rgba(0, 0, 0, 0);
    color: #fff;
    font-family: 'Arial Black', 'Arial Bold', sans-serif;
    font-size: 2.5vh;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  #menu-container {
    display: inline-block;
    transition: transform 0.3s ease;
    transform-origin: center center;
    background: linear-gradient(180deg, #3a4050 0%, #2a2e3a 50%, #1a1e2a 100%);
    border-radius: 2vh;
    padding: 3vh 2vh;
    box-shadow:
      0 1vh 2vh rgba(0,0,0,0.8),
      inset 0 0.2vh 0.5vh rgba(255,255,255,0.1),
      inset 0 -0.2vh 0.5vh rgba(0,0,0,0.5);
    border: 0.3vh solid #1a1e2a;
    position: relative;
  }

  #menu-container::before {
    content: '';
    position: absolute;
    top: -1vh;
    left: 50%;
    transform: translateX(-50%);
    width: 60%;
    height: 2vh;
    background: linear-gradient(180deg, #4a5060 0%, #3a4050 100%);
    border-radius: 1vh 1vh 0 0;
    box-shadow:
      0 0.2vh 0.5vh rgba(0,0,0,0.5),
      inset 0 0.1vh 0.3vh rgba(255,255,255,0.2);
  }

    .menu-title {
      font-size: 3.5vh;
      font-weight: bold;
      text-align: center;
      margin-bottom: 2.5vh;
      padding: 1.5vh 2vh;
      color: #9a9eb0;
      text-transform: uppercase;
      letter-spacing: 0.4vh;
      background: transparent;
      text-shadow:
        0 0.15vh 0.2vh rgba(255,255,255,0.3),
        0 -0.1vh 0.2vh rgba(0,0,0,0.8);
    }

    ul.menu {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    li.menu-item {
      padding: 2vh 3vh;
      margin-bottom: 1.5vh;
      background: linear-gradient(180deg, #6a7a90 0%, #5a6a80 30%, #4a5a70 70%, #3a4a60 100%);
      border-radius: 1vh;
      cursor: pointer;
      position: relative;
      font-size: 2.8vh;
      font-weight: bold;
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 0.2vh;
      color: #e8ecf4;
      text-shadow: 0 0.2vh 0.4vh rgba(0,0,0,0.8);
      box-shadow:
        0 0.6vh 1.2vh rgba(0,0,0,0.7),
        inset 0 0.3vh 0.5vh rgba(255,255,255,0.25),
        inset 0 -0.3vh 0.5vh rgba(0,0,0,0.4);
      border: 0.2vh solid #2a3a4a;
      border-bottom: 0.4vh solid #1a2a3a;
      transition: all 0.15s ease;
    }

    li.menu-item::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 1vh;
      transform: translateY(-50%);
      width: 1vh;
      height: 1vh;
      background: radial-gradient(circle, #8af 0%, #569 100%);
      border-radius: 50%;
      box-shadow: 0 0 0.5vh rgba(136,170,255,0.6);
      opacity: 0;
      transition: opacity 0.15s ease;
    }

    li.menu-item.selected {
      background: linear-gradient(180deg, #7a9ac0 0%, #6a8ab0 30%, #5a7aa0 70%, #4a6a90 100%);
      box-shadow:
        0 0.8vh 1.6vh rgba(0,0,0,0.9),
        inset 0 0.4vh 0.8vh rgba(255,255,255,0.3),
        inset 0 -0.4vh 0.8vh rgba(0,0,0,0.5),
        0 0 2vh rgba(136,170,255,0.4);
      transform: translateY(-0.2vh);
      border-color: #4a6a8a;
    }

    li.menu-item.selected::before {
      opacity: 1;
    }

    li.menu-item:active {
      transform: translateY(0.3vh);
      box-shadow:
        0 0.3vh 0.6vh rgba(0,0,0,0.8),
        inset 0 0.2vh 0.4vh rgba(255,255,255,0.2),
        inset 0 -0.2vh 0.4vh rgba(0,0,0,0.5);
    }

    #overlay-root {
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }

    #overlay-root.active {
      opacity: 1;
      pointer-events: auto;
    }
  </style>
</head>

<body>
  <div id="menu-container">
    <div class="menu-title">Settings</div>
    <ul class="menu" id="menu">
      <li class="menu-item" id="buildmeta-item">Build Metadata</li>
      <li class="menu-item" id="quit-item">Quit</li>
    </ul>
  </div>

  <!-- Build Metadata Overlay -->
  <div id="buildmeta-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #222; padding: 3vh; border-radius: 1vh; min-width: 40vw;">
      <div id="buildmeta-options" style="display: block;">
        <h2 style="margin: 0 0 2vh 0; font-size: 3vh;">Build Metadata Options</h2>
        <div style="margin-bottom: 2vh;">
          <label style="display: flex; align-items: center; margin-bottom: 1.5vh; cursor: pointer;">
            <input type="checkbox" id="update-all-check" style="margin-right: 1vh; width: 2vh; height: 2vh;">
            <div>
              <div style="font-size: 2.2vh; font-weight: bold;">Update All Tables</div>
              <div style="font-size: 1.6vh; color: #999;">Reparse all tables, even if meta.ini already exists</div>
            </div>
          </label>
          <label style="display: flex; align-items: center; cursor: pointer;">
            <input type="checkbox" id="download-media-check" checked style="margin-right: 1vh; width: 2vh; height: 2vh;">
            <div>
              <div style="font-size: 2.2vh; font-weight: bold;">Download Media</div>
              <div style="font-size: 1.6vh; color: #999;">Automatically download table images from VPSdb</div>
            </div>
          </label>
        </div>
        <div style="display: flex; justify-content: flex-end; gap: 1vh; margin-top: 3vh;">
          <button id="buildmeta-cancel" style="padding: 1vh 2vh; background: #444; border: none; color: #fff; border-radius: 0.5vh; cursor: pointer; font-size: 2vh;">Cancel</button>
          <button id="buildmeta-start" style="padding: 1vh 2vh; background: #2196F3; border: none; color: #fff; border-radius: 0.5vh; cursor: pointer; font-size: 2vh;">Start Build</button>
        </div>
      </div>
      <div id="buildmeta-progress" style="display: none;">
        <h2 style="margin: 0 0 2vh 0; font-size: 3vh;">Building Metadata</h2>
        <div style="background: #333; border-radius: 0.5vh; height: 2vh; margin-bottom: 1vh; overflow: hidden;">
          <div id="progress-bar" style="background: #2196F3; height: 100%; width: 0%; transition: width 0.3s;"></div>
        </div>
        <div id="progress-text" style="font-size: 1.8vh; color: #ccc; margin-bottom: 2vh;">Starting...</div>
        <div id="log-container" style="background: #111; border-radius: 0.5vh; padding: 1vh; max-height: 30vh; overflow-y: auto; font-family: monospace; font-size: 1.4vh; color: #0f0;">
        </div>
        <div style="display: flex; justify-content: flex-end; margin-top: 2vh;">
          <button id="buildmeta-close" style="padding: 1vh 2vh; background: #444; border: none; color: #fff; border-radius: 0.5vh; cursor: pointer; font-size: 2vh; display: none;">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let rotationAngle = 0; // starting angle
    let selectedIndex = 0;
    let items = [];
    let dialogState = null; // 'options' or 'progress' or null
    let dialogSelectedIndex = 0; // for navigating dialog options
    let dialogItems = []; // checkboxes and buttons in dialog

    window.parent.vpin.registerInputHandlerMenu(handleInput);

    // Keyboard input handler for main menu (mirrors vpinfe-core.js mappings)
    // ShiftLeft = up/left, ShiftRight = down/right, Enter = select
    window.addEventListener('keydown', (e) => {
      if (e.code === 'ShiftLeft' || e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
        handleInput("joyleft");
        e.preventDefault();
      } else if (e.code === 'ShiftRight' || e.key === 'ArrowRight' || e.key === 'ArrowDown') {
        handleInput("joyright");
        e.preventDefault();
      } else if (e.key === 'Enter') {
        handleInput("joyselect");
        e.preventDefault();
      } else if (e.key === 'Escape') {
        handleInput("joyback");
        e.preventDefault();
      }
    });

    window.addEventListener("message", (event) => {
      const message = event.data;
      if (message.event === "reset state") {
        selectedIndex = 0;
        updateMenu();
      }
    });

    window.addEventListener("DOMContentLoaded", () => {
      rotateMenu(rotationAngle); // apply initial rotation
    });

    function rotateMenu(degrees) {
      rotationAngle = degrees;
      document.getElementById('menu-container').style.transform =
        `rotate(${rotationAngle}deg)`;
    }

    function handleInput(input) {
      console.log("got input: " + input);

      // Handle dialog navigation separately
      if (dialogState === 'options') {
        handleDialogInput(input);
        return;
      } else if (dialogState === 'progress') {
        // In progress state, only allow closing if done
        if (input === "joyback" || input === "joyselect") {
          const closeBtn = document.getElementById('buildmeta-close');
          if (closeBtn.style.display !== 'none') {
            hideBuildMetaDialog();
          }
        }
        return;
      }

      // Normal menu navigation
      switch (input) {
        case "joyup":
        case "joyleft":
          selectedIndex = (selectedIndex - 1 + items.length) % items.length;
          break;
        case "joydown":
        case "joyright":
          selectedIndex = (selectedIndex + 1) % items.length;
          break;
        case "joyselect":
          const selectedItem = items[selectedIndex];
          if (selectedItem.id === 'quit-item') {
            window.parent.vpin.call("close_app");
          } else if (selectedItem.id === 'buildmeta-item') {
            showBuildMetaDialog();
          }
          break;
        case "joyback":
          // Close the menu by calling the parent's menu toggle
          window.parent.vpin.toggleMenu();
          break;
      }
      updateMenu();
    }

    function handleDialogInput(input) {
      switch (input) {
        case "joyup":
        case "joyleft":
          dialogSelectedIndex = (dialogSelectedIndex - 1 + dialogItems.length) % dialogItems.length;
          updateDialogSelection();
          break;
        case "joydown":
        case "joyright":
          dialogSelectedIndex = (dialogSelectedIndex + 1) % dialogItems.length;
          updateDialogSelection();
          break;
        case "joyselect":
          const selectedElement = dialogItems[dialogSelectedIndex];
          if (selectedElement.type === 'checkbox') {
            selectedElement.checked = !selectedElement.checked;
          } else if (selectedElement.tagName === 'BUTTON') {
            selectedElement.click();
          }
          break;
        case "joyback":
          hideBuildMetaDialog();
          break;
      }
    }

    function updateDialogSelection() {
      dialogItems.forEach((item, i) => {
        if (item.tagName === 'BUTTON') {
          if (i === dialogSelectedIndex) {
            item.style.outline = '3px solid #2196F3';
            item.style.outlineOffset = '2px';
          } else {
            item.style.outline = 'none';
          }
        } else if (item.parentElement && item.parentElement.tagName === 'LABEL') {
          if (i === dialogSelectedIndex) {
            item.parentElement.style.outline = '3px solid #2196F3';
            item.parentElement.style.outlineOffset = '2px';
          } else {
            item.parentElement.style.outline = 'none';
          }
        }
      });
    }

    function showBuildMetaDialog() {
      document.getElementById('buildmeta-overlay').style.display = 'block';
      document.getElementById('buildmeta-options').style.display = 'block';
      document.getElementById('buildmeta-progress').style.display = 'none';

      // Set up dialog state
      dialogState = 'options';
      dialogSelectedIndex = 0;
      dialogItems = [
        document.getElementById('update-all-check'),
        document.getElementById('download-media-check'),
        document.getElementById('buildmeta-cancel'),
        document.getElementById('buildmeta-start')
      ];
      updateDialogSelection();
    }

    function hideBuildMetaDialog() {
      document.getElementById('buildmeta-overlay').style.display = 'none';
      dialogState = null;
      dialogItems = [];
      dialogSelectedIndex = 0;
    }

    function startBuildMeta() {
      const updateAll = document.getElementById('update-all-check').checked;
      const downloadMedia = document.getElementById('download-media-check').checked;

      // Switch to progress view
      document.getElementById('buildmeta-options').style.display = 'none';
      document.getElementById('buildmeta-progress').style.display = 'block';
      document.getElementById('log-container').innerHTML = '';
      document.getElementById('progress-bar').style.width = '0%';
      document.getElementById('progress-text').textContent = 'Starting...';
      document.getElementById('buildmeta-close').style.display = 'none';

      // Update dialog state
      dialogState = 'progress';
      dialogItems = [];
      dialogSelectedIndex = 0;

      // Call API to start build
      window.parent.vpin.call("build_metadata", downloadMedia, updateAll);
    }

    // Handle buildmeta events from API
    window.receiveEvent = function(event) {
      console.log('[mainmenu] Received event:', event.type, event);

      if (event.type === 'buildmeta_progress') {
        const percent = event.total > 0 ? Math.round((event.current / event.total) * 100) : 0;
        document.getElementById('progress-bar').style.width = percent + '%';
        document.getElementById('progress-text').textContent = event.message + ' â€” ' + percent + '%';
        console.log('[mainmenu] Updated progress:', percent + '%');
      } else if (event.type === 'buildmeta_log') {
        const logContainer = document.getElementById('log-container');
        const logLine = document.createElement('div');
        logLine.textContent = event.message;
        logLine.style.marginBottom = '0.3vh';
        logContainer.appendChild(logLine);
        logContainer.scrollTop = logContainer.scrollHeight;
        console.log('[mainmenu] Added log:', event.message);
      } else if (event.type === 'buildmeta_complete') {
        document.getElementById('progress-bar').style.width = '100%';
        document.getElementById('progress-text').textContent =
          `Complete! ${event.result.found} tables scanned, ${event.result.not_found} not found in VPSdb`;
        document.getElementById('buildmeta-close').style.display = 'block';
        console.log('[mainmenu] Build complete');
      } else if (event.type === 'buildmeta_error') {
        document.getElementById('progress-text').textContent = 'Error: ' + event.error;
        document.getElementById('progress-text').style.color = '#f44336';
        document.getElementById('buildmeta-close').style.display = 'block';
        console.log('[mainmenu] Build error:', event.error);
      }
    };

    console.log('[mainmenu] receiveEvent handler registered');

    function updateMenu() {
      items.forEach((item, i) => {
        item.classList.toggle('selected', i === selectedIndex);
      });
    }

    window.onload = async () => {
      items = Array.from(document.querySelectorAll('.menu-item'));
      updateMenu();

      // Setup buildmeta dialog button handlers
      document.getElementById('buildmeta-cancel').addEventListener('click', hideBuildMetaDialog);
      document.getElementById('buildmeta-start').addEventListener('click', startBuildMeta);
      document.getElementById('buildmeta-close').addEventListener('click', hideBuildMetaDialog);
    };
  </script>
</body>

</html>
