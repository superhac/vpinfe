name: Build VPinFE (Cross-Platform)

on:
  push:
    branches: [ master, vpinfe-chromium ]
  pull_request:
    branches: [ master, vpinfe-chromium ]

jobs:
  build:
    strategy:
      matrix:
        #os: [ubuntu-latest, windows-latest, macos-latest]
        os: [macos-latest]
    runs-on: ${{ matrix.os }}

    steps:
      # 1. Checkout repo
      - uses: actions/checkout@v3

      # 2. Set up Python 3.14
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.14'

      # 3. Install dependencies
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      
      # 13. Build macOS slim variant (no bundled Chromium - uses system Chrome/Chromium)
      - name: Build slim app with PyInstaller (macOS)
        if: runner.os == 'macOS'
        run: |
          rm -rf build dist
          pyinstaller --windowed -i icon/VPinFE.icns --osx-bundle-identifier com.vpinfe.main --noconfirm --name VPinFE \
            --add-data "web:web" \
            --add-data "managerui/static:managerui/static" \
            main.py
          #Remove extended attributes so it doesn't fully quarantine
          echo "Removing extended attributes."
          sudo xattr -rc dist
          echo $?
        shell: bash
      - name: Ad-hoc sign the app (macOS)
        if: runner.os == 'macOS'
        run: |
          codesign --force --deep --sign - dist/VPinFE.app
  shell: bash
      - name: Upload slim build artifact (macOS)
        if: runner.os == 'macOS'
        uses: actions/upload-artifact@v4
        with:
          name: vpinfe-macOS-slim
          path: dist/
