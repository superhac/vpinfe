name: Build VPinFE (Cross-Platform)

on:
  push:
    branches: [ master, vpinfe-chromium ]
  pull_request:
    branches: [ master, vpinfe-chromium ]

jobs:
  build:
    strategy:
      matrix:
        #os: [ubuntu-latest, windows-latest, macos-latest]
        os: [macos-latest]
    runs-on: ${{ matrix.os }}

    steps:
      # 1. Checkout repo
      - uses: actions/checkout@v3

      # 2. Set up Python 3.14
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.14'

      # 3. Install dependencies
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      # 4a. Create Chromium directories (Linux/macOS)
      - name: Create Chromium directories (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          mkdir -p chromium/linux chromium/windows chromium/mac
        shell: bash

      # 4b. Create Chromium directories (Windows)
      - name: Create Chromium directories (Windows)
        if: runner.os == 'Windows'
        run: |
          New-Item -ItemType Directory -Force -Path chromium\linux,chromium\windows,chromium\mac

      # 5. Download Linux Chromium
      - name: Download Linux Chromium
        if: runner.os == 'Linux'
        run: |
          wget -O chromium/linux/chrome.zip "https://www.googleapis.com/download/storage/v1/b/chromium-browser-snapshots/o/Linux_x64%2F1568190%2Fchrome-linux.zip?generation=1768270474193258&alt=media"
          #wget -O chromium/linux/chrome.zip "https://www.googleapis.com/download/storage/v1/b/chromium-browser-snapshots/o/Linux_x64%2F1582450%2Fchrome-linux.zip?alt=media"
          unzip -q chromium/linux/chrome.zip -d chromium/linux
          mv chromium/linux/chrome-linux chromium/linux/chrome
          chmod +x chromium/linux/chrome/chrome

      # 6. Download Windows Chromium
      - name: Download Windows Chromium
        if: runner.os == 'Windows'
        run: |
          pwsh -Command "Invoke-WebRequest -Uri 'https://www.googleapis.com/download/storage/v1/b/chromium-browser-snapshots/o/Win_x64%2F1568195%2Fchrome-win.zip?generation=1768274160162696&alt=media' -OutFile 'chromium/windows/chrome.zip' -UseBasicParsing"
          #pwsh -Command "Invoke-WebRequest -Uri 'https://www.googleapis.com/download/storage/v1/b/chromium-browser-snapshots/o/Win_x64%2F1582426%2Fchrome-win.zip?alt=media' -OutFile 'chromium/windows/chrome.zip' -UseBasicParsing"
          pwsh -Command "Expand-Archive -Path 'chromium/windows/chrome.zip' -DestinationPath 'chromium/windows'"
          pwsh -Command "Remove-Item 'chromium/windows/chrome.zip'"

      # 7. Download Mac Chromium (ARM)
      - name: Download Mac Chromium
        if: runner.os == 'macOS'
        run: |
          mkdir -p chromium
          curl -L -o chrome-mac.zip "https://www.googleapis.com/download/storage/v1/b/chromium-browser-snapshots/o/Mac_Arm%2F1582847%2Fchrome-mac.zip?generation=1770766943434586&alt=media"
          unzip -q chrome-mac.zip
          mv chrome-mac/Chromium.app chromium/Chromium.app
          rm -rf chrome-mac chrome-mac.zip

      # 8. Build with PyInstaller
      - name: Build app with PyInstaller
        run: |
          if [[ "$RUNNER_OS" == "Linux" ]]; then
            pyinstaller --onedir --noconfirm --name vpinfe \
              --add-data "web:web" \
              --add-data "managerui/static:managerui/static" \
              --add-data "chromium/linux/chrome:chromium/linux/chrome" \
              --hidden-import pynput.keyboard._xorg \
              --hidden-import pynput.mouse._xorg \
              main.py
          elif [[ "$RUNNER_OS" == "Windows" ]]; then
            pyinstaller --onedir --noconfirm --name vpinfe \
              --add-data "web;web" \
              --add-data "managerui/static;managerui/static" \
              --add-data "chromium/windows;chromium/windows" \
              main.py
          elif [[ "$RUNNER_OS" == "macOS" ]]; then
            pyinstaller --onedir --noconfirm --name vpinfe \
              --add-data "web:web" \
              --add-data "managerui/static:managerui/static" \
              main.py
            # Preserve Chromium.app bundle structure (PyInstaller breaks symlinks)
            mkdir -p dist/vpinfe/_internal/chromium
            cp -R chromium/Chromium.app dist/vpinfe/_internal/chromium/Chromium.app
            chmod +x dist/vpinfe/_internal/chromium/Chromium.app/Contents/MacOS/Chromium
          fi
        shell: bash

      # 9. Copy Windows launcher bat file
      - name: Copy Windows launcher
        if: runner.os == 'Windows'
        run: cp vpinfe.bat dist/vpinfe/
        shell: bash

      # 10. Upload artifact per OS
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: vpinfe-${{ runner.os }}
          path: dist/

      # 11. Build Linux slim variant (no bundled Chromium - uses system chromium)
      - name: Build slim app with PyInstaller (Linux)
        if: runner.os == 'Linux'
        run: |
          rm -rf build dist
          pyinstaller --onedir --noconfirm --name vpinfe \
            --add-data "web:web" \
            --add-data "managerui/static:managerui/static" \
            --hidden-import pynput.keyboard._xorg \
            --hidden-import pynput.mouse._xorg \
            main.py
        shell: bash

      - name: Upload slim build artifact (Linux)
        if: runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: vpinfe-Linux-slim
          path: dist/

      # 12. Build Windows slim variant (no bundled Chromium - uses system Chrome/Chromium)
      - name: Build slim app with PyInstaller (Windows)
        if: runner.os == 'Windows'
        run: |
          Remove-Item -Recurse -Force build, dist -ErrorAction SilentlyContinue
          pyinstaller --onedir --noconfirm --name vpinfe `
            --add-data "web;web" `
            --add-data "managerui/static;managerui/static" `
            main.py

      - name: Copy Windows launcher (slim)
        if: runner.os == 'Windows'
        run: cp vpinfe.bat dist/vpinfe/
        shell: bash

      - name: Upload slim build artifact (Windows)
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: vpinfe-Windows-slim
          path: dist/

      # 13. Build macOS slim variant (no bundled Chromium - uses system Chrome/Chromium)
      - name: Build slim app with PyInstaller (macOS)
        if: runner.os == 'macOS'
        run: |
          rm -rf build dist
          pyinstaller --windowed -i icon/VPinFE.icns --osx-bundle-identifier com.vpinfe.main --noconfirm --name VPinFE \
            --add-data "web:web" \
            --add-data "managerui/static:managerui/static" \
            main.py
          #Remove extended attributes so it doesn't fully quarantine
          sudo xattr -cr dist/VPinFE.app 
        shell: bash

      - name: Upload slim build artifact (macOS)
        if: runner.os == 'macOS'
        uses: actions/upload-artifact@v4
        with:
          name: vpinfe-macOS-slim
          path: dist/VPinFE.app
